---
title: "Predatory Lending Locations"
author: "Datalab"
runtime: shiny
output:
  flexdashboard::flex_dashboard:
    theme:
      version: 4
      bg: "#FAFBFE"
      fg: "#555555" 
      primary: "#ad4944"
      navbar-bg: "#DE9D49"
      base_font: 
        google: Prompt
      heading_font:
        google: Helvetica
      code_font:
        google: 
          family: mono
          local: false
    orientation: row
    vertical_layout: fill
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(flexdashboard)
library(shiny)
library(tidyverse)
library(DT)
library(plotly)
library(leaflet)
library(leaflet.extras)
library(gsheet)
library(rgdal)
library(raster)
library(RColorBrewer)
library(forcats)
library(lubridate)
library(googlesheets4)
library(sf)
library(fontawesome)
library(htmltools)
library(tidyverse)

```

```{r df, include = FALSE}
# reading in TN county polygon data
tncounty<- shapefile('/Users/elizabethmorris/Desktop/Datalab 2022/betterfi/TN_counties/TN_counties')
tncounty<- spTransform(tncounty, CRS("+init=epsg:4326"))

# selecting counties in area
counties <- c('Hamilton', 'Marion', 'Franklin', 'Coffee', 'Grundy')

boundaries <- tncounty[tncounty$NAME %in% counties,]

# reading in map loan data from g sheet
maploan<- read_csv('maploan1.csv')

# county median income
countyincome <- read_csv('countymedianincome.csv')

```


```{r icons, echo = FALSE}

paldata<-maploan %>% group_by(county, countyincome, countypop) %>% summarise(total = n())

mergemap <- merge(boundaries, paldata,  by.x = 'NAME', by.y = 'county')


pal <- colorNumeric(
    palette = "Reds",
    domain = paldata$total)
# Loaing in awesome icon, its a bit finicky but works
cash <- makeAwesomeIcon(
  icon = "money bill",
  iconColor = "#FAFBFE",
  markerColor ="red",
  library = "fa")

# making popup labels
labels <- sprintf(
  "<strong>%s</strong><br/>%g median income<br/>%g people ",
  mergemap$NAMELSAD, mergemap$countyincome, mergemap$countypop
) %>% lapply(htmltools::HTML)


```


 {data-orientation=rows}
=======================================

Row
---------------------------------------
###

```{r}
renderValueBox({
  valueBox("Number of Payday Loans in TN",
           value = "1,293",
           icon = "fa-bring-forward")
})
```

###

```{r}
renderValueBox({
  valueBox("Number of McDonald's in TN",
           value = "285",
          icon = "fa-burger")
})
```


Row
---------------------------------------

### Map

```{r map, echo = FALSE}
renderLeaflet({
leaflet() %>%
  addProviderTiles(providers$OpenStreetMap) %>%
  addAwesomeMarkers(data = maploan,
                    label = ~maploan$apr, 
                    icon = cash)%>%
  addPolygons(data = mergemap,
              color = "orange",
              fillColor = ~pal(total),
              fillOpacity = .6,
              weight = 2,
              opacity = .9,
              label = ~labels,
              labelOptions = labelOptions(
    style = list("font-weight" = "normal", padding = "3px 8px"),
    textsize = "15px",
    direction = "auto"),
              highlightOptions = highlightOptions(
                color = "#f0e771", bringToFront = TRUE )) %>%
   addControlGPS(options = gpsOptions(
                position = "topleft", activate = TRUE,
                autoCenter = TRUE, maxZoom = 200,
                setView = TRUE)) %>% 
    addLegend(pal = pal,
        values = paldata$total,
        opacity = 0.7,
        title = htmltools::HTML("# of Payday Loans"),
        position = "bottomright")

})

```
