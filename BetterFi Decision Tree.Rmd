---
title: "Decision Tree - 3 Categories"
author: "Tilina Alzaben"
date: '2022-06-21'
output:
  word_document: default
  html_document: default
  pdf_document: default
---

```{r}
set.seed(42)
```

```{r}
# install.packages('readr')
# install.packages('ggplot2')
# install.packages('dplyr')
# install.packages('knitr')
# install.packages('lubridate')
# install.packages('tree')
# install.packages('caret')
# install.packages('rpart')
# install.packages('rpart.plot')
# install.packages('mlr')
# install.packages('caret')
# install.packages('randomForest')
# install.packages('tree')
```

```{r, echo = FALSE}
#IMPORT LIBRARIES
library(readr)
library(ggplot2)
library(dplyr)
library(knitr)
library(lubridate)
library(tree)
library(rpart)
library(rpart.plot)
library(mlr)
library(caret)
library(randomForest)
library(tree)
```

```{r, echo = FALSE}
#Read in the Client and Loan Data
client <- read_csv("C:/Users/tilin/Desktop/BetterFi/Copy of DataLab-clientdata-anon.csv")
loan <- read_csv("C:/Users/tilin/Desktop/BetterFi/Copy of DataLab-loandata-anon.csv")
loan2 <- read_csv("C:/Users/tilin/Downloads/LOAN-DATA-070122.csv")
```

```{r}
#Cleaning Client Data
clientClean <- client %>% 
  mutate(streetcity = case_when(streetcity == 'Traciy City' | streetcity == 'TRACY CITY' ~ 'Tracy City', 
                                streetcity == 'TULLAHOMA' ~ 'Tullahoma',
                                TRUE ~ streetcity)) %>%  
  mutate(employer = ifelse(is.na(employer), "UNEMPLOYED", client$employer)) %>% 
  mutate(incomeamt = case_when(incomefreq == 'MO' || incomefreq == 'mo' ~ incomeamt, 
                               incomefreq == 'biwk' || incomefreq == 'BI' ~ incomeamt * 2, 
                               incomefreq == 'WE' ~ incomeamt * 4)) %>% 
  mutate(residenceyear= floor(as.numeric(residenceperiod)/12)) %>% 
  mutate(carsinhh = ifelse(is.na(carsinhh), 0, carsinhh)) %>% 
  mutate(County = ifelse(is.na(County), 'Suffolk County', client$County)) %>%
  mutate(totalExpense = rowSums(client[,c(54, 55, 56, 57, 59)], na.rm = TRUE)) %>% 
  select(custID,
         streetcity, 
         streetzip, 
         County, 
         income_source, 
         employer,
         incomeamt, 
         annualincome, 
         incomelevel, 
         totalExpense, 
         carsinhh, 
         residenceyear, 
         referenceperson)
clientClean %>% View
```

```{r}
#Cleaning Loan Data
loanClean <- loan %>% 
  mutate(status_code = ifelse(is.na(status_code), "active", loan$status_code)) %>% 
  select(primary_borrower_name, status_code, purpose, amount_approved, full_identifier)

loan2Clean <- loan2 %>% 
  select(payment_periods, primary_borrower_name, loan_identifier) %>% 
  mutate(payment_periods = gsub("mo","", as.character(payment_periods))) 

loanData <- merge(loanClean, loan2Clean, by.x = 'full_identifier', by.y = 'loan_identifier') %>% 
  mutate(monthlyPayment = round(amount_approved/as.numeric(payment_periods), 2))

loanData <- loanData[-7]
loanData %>% View
```

```{r}
#Creating One Data set
df <- merge(clientClean, loanData, by.x = 'custID', by.y = 'primary_borrower_name.x')
df <- df[df$status_code != 'active',] 
df <- df[-c(1, 14)]
df %>% View
```

```{r}
#Turning Categorical Variables into Factors
cat <- c('streetcity', 'streetzip', 'County', 'income_source', 'employer', 'referenceperson', 
         'incomelevel', 'status_code', 'purpose', 'carsinhh', 'residenceyear', 'payment_periods')

for(x in cat) {
    df[, x] <- as.factor(df[, x])
}

str(df)
```

```{r}
## Training/Testing/Validation Data Sets
set.seed(100)
trainRowNumbers <- createDataPartition(df$status_code, p=0.7, list=FALSE)

train <- df[trainRowNumbers,]
test <- df[-trainRowNumbers,]
dim(train); dim(test)
```

```{r}
## Feature Selection
control <- trainControl(method="repeatedcv", number=10, repeats=3)
model <- train(status_code~.,
               data=train,
               method="lvq",
               preProcess="scale",
               trControl=control,
               na.action = na.omit)

importance <- varImp(model, scale=FALSE)
print(importance)
plot(importance)
```

```{r}
## 10 CROSS VALIDATION MODEL
control <- trainControl(method="repeatedcv", number=10, repeats=10)
model <- train(status_code ~ ., 
               data = train, 
               method = "rpart", 
               trControl = control, 
               na.action = na.pass)

#Printing the Model
print(model)
summary(model$finalModel)
```



```{r}
#CLASSIFICATION Decision Tree

#MODEL NUMBER 1 - ALL VARIABLES
model0 = tree(status_code ~ ., 
             na.action = na.pass, 
             method = "class", 
             split = c("deviance", "gini"),
             data = train)
summary(model0)
```

```{r}
#Variables Used in Decision Tree
summary(model0)$used

#Variables Not Used in Decision Tree
names(train)[which(!(names(train) %in% summary(model0)$used))]
```

```{r}
#Plotting the Decision Tree
plot(model0)
text(model0)

#Pruned Decision Tree
prune0 = prune.misclass(model0, best = 8)
summary(prune0)

plot(prune0)
text(prune0, pretty = 0)
title(main = "Pruned Classification Tree")
```

```{r}
#Confusion Matrix
#BASE MODEL ACCURACY: 86%
model0_pred = predict(model0, train, type = "class")
table(predicted = model0_pred, actual = train$status_code)

#Testing the Decision Tree
pred <- predict(model0, test) 
pred
```
```{r}
cv_model <- cv.tree(model0, FUN = prune.misclass)
plot(cv_model$size, cv_model$dev, type = "b")

prune_carseats = prune.misclass(model0, best = 6)
plot(prune_carseats)
text(prune_carseats, pretty = 0)

tree_pred = predict(prune_carseats, test, type = "class")
table(tree_pred, test$status_code)
```
    
    
```{r}
set.seed(1)
rf_model = randomForest(status_code~., 
                          data = train, 
                          mtry = 13, 
                          importance = TRUE, 
                        na.action = na.omit)

bagged_estimate = predict(rf_model, 
                          newdata = test)

install.packages('ggplot2')
library(ggplot2)
ggplot() + 
    geom_point(aes(x = test$medv, y = bagged_estimate)) +
    geom_abline()
```
  
    
    
    
    
    
    
```{r}
#Model 1 - 80% ACCURACY
model1 = tree(status_code ~ amount_approved + monthlyPayment + streetzip +  employer + annualincome + purpose, 
             na.action = na.pass, 
             method = "class", 
             split = c("deviance", "gini"),
             data = train)
summary(model1)

model1_pred = predict(model1, train, type = "class")
table(predicted = model1_pred, actual = train$status_code)
# save(model2,file = 'model.RData')
```

```{r}
#Model 2 - 79% ACCURACY
model2 = tree(status_code ~ annualincome + amount_approved + streetzip + income_source + monthlyPayment, 
             na.action = na.pass, 
             method = "class", 
             split = c("deviance", "gini"),
             data = train)
summary(model2)

model2_pred = predict(model2, train, type = "class")
table(predicted = model2_pred, actual = train$status_code)
```


```{r}
#Model 3 - 80% ACCURACY
model3 = tree(status_code ~ amount_approved + employer + annualincome + monthlyPayment + 
                streetzip + income_source + referenceperson + purpose,
             na.action = na.pass, 
             method = "class", 
             split = c("deviance", "gini"),
             data = train)
summary(model3)

model3_pred = predict(model3, train, type = "class")
table(predicted = model3_pred, actual = train$status_code)
```

```{r}
#Model 4 - 71% ACCURACY
model4 = tree(status_code ~ County + carsinhh + totalExpense + residenceyear + cellphone,
             na.action = na.pass, 
             method = "class", 
             split = c("deviance", "gini"),
             data = train)
summary(model4)

model4_pred = predict(model4, train, type = "class")
table(predicted = model4_pred, actual = train$status_code)
```

```{r}
#Model 7 - 80% ACCURACY
model7 = tree(status_code ~ amount_approved + employer + annualincome + referenceperson + streetzip + purpose + income_source + carsinhh,
             na.action = na.pass, 
             method = "class", 
             split = c("deviance", "gini"),
             data = train)
summary(model7)

model7_pred = predict(model7, train, type = "class")
table(predicted = model7_pred, actual = train$status_code)
```


```{r}
#Model 10 - 80% ACCURACY
model10 = tree(status_code ~ amount_approved + employer + annualincome + streetzip + referenceperson + income_source,
             na.action = na.pass, 
             method = "class", 
             split = c("deviance", "gini"),
             data = train)
summary(model10)

model10_pred = predict(model10, train, type = "class")
table(predicted = model10_pred, actual = train$status_code)
```



