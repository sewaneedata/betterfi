---
title: "BetterFi"
author: "Tilina Alzaben"
date: '2022-06-21'
output:
  word_document: default
  html_document: default
  pdf_document: default
---

```{r, echo = FALSE}
#IMPORT LIBRARIES
library(readr)
library(ggplot2)
library(dplyr)
library(knitr)
library(lubridate)
library(tree)
```

```{r, echo = FALSE}
#Read in the Client and Loan Data
client <- read_csv("C:/Users/tilin/Desktop/BetterFi/Copy of DataLab-clientdata-anon.csv")
loan <- read_csv("C:/Users/tilin/Desktop/BetterFi/Copy of DataLab-loandata-anon.csv")
loan2 <- read_csv("C:/Users/tilin/Downloads/LOAN-DATA-070122.csv")
```

```{r}
#Cleaning Client Data
clientClean <- client %>% 
  mutate(age = year(Sys.Date()) - dob) %>%
  mutate(streetcity = case_when(streetcity == 'Traciy City' | streetcity == 'TRACY CITY' ~ 'Tracy City', 
                                streetcity == 'TULLAHOMA' ~ 'Tullahoma',
                                TRUE ~ streetcity)) %>%  
  mutate(employer = ifelse(is.na(employer), "UNEMPLOYED", client$employer)) %>% 
  mutate(incomeamt = case_when(incomefreq == 'MO' || incomefreq == 'mo' ~ incomeamt, 
                               incomefreq == 'biwk' || incomefreq == 'BI' ~ incomeamt * 2, 
                               incomefreq == 'WE' ~ incomeamt * 4)) %>% 
  mutate(residenceyear= floor(as.numeric(residenceperiod)/12)) %>% 
  mutate(carsinhh = ifelse(is.na(carsinhh), 0, carsinhh)) %>% 
  mutate(residencetype = ifelse(is.na(residencetype), 'UNKNOWN', client$residencetype)) %>% 
  select(custID,
         sex, 
         age, 
         cellphone, 
         streetcity, 
         streetzip,
         income_source, 
         employer,
         incomeamt,
         referenceperson,
         carsinhh,
         residenceyear,
         annualincome,
         County,
         incomelevel)
clientClean %>% View
```

```{r}
#Cleaning Loan Data
loanClean <- loan %>% 
  mutate(status_code = ifelse(is.na(status_code), "active", loan$status_code)) %>% 
  select(primary_borrower_name, status_code, purpose, amount_approved, full_identifier)

loan2Clean <- loan2 %>% 
  mutate(primary_person_population_classification = ifelse(primary_person_population_classification == "non_urban", 'rural', primary_person_population_classification)) %>% 
  select(total_disbursements, payment_periods, primary_person_population_classification, primary_borrower_name, loan_identifier)

loanData <- merge(loanClean, loan2Clean, by.x = 'full_identifier', by.y = 'loan_identifier')

loanData %>% View
```

```{r}
#Creating One Data set
df <- merge(clientClean, loanData, by.x = 'custID', by.y = 'primary_borrower_name.x')
df <- df[-c(23,16)]
df %>% View

df <- df[df$status_code != 'active',]
df <- df[df$incomelevel != '#N/A',]
df %>% View
```

```{r}
#Turning Categorical Variables into Factors
df$sex <- as.factor(df$sex)
df$cellphone <- as.factor(df$cellphone)
df$streetcity <- as.factor(df$streetcity)
df$streetzip <- as.factor(df$streetzip)
df$County <- as.factor(df$County)
df$income_source <- as.factor(df$income_source)
df$employer <- as.factor(df$employer)
df$referenceperson <- as.factor(df$referenceperson)
df$incomelevel <- as.factor(df$incomelevel)
df$carsinhh <- as.factor(df$carsinhh)
df$payment_periods <- as.factor(df$payment_periods)
df$primary_person_population_classification <- as.factor(df$primary_person_population_classification)

df$status_code <- as.factor(df$status_code)
df$purpose <- as.factor(df$purpose)

#Dropping the 'active' Factor
df$status_code <- droplevels(df$status_code)
df$incomelevel <- droplevels(df$incomelevel)
str(df)
```

```{r}
#Validation Data Set
val <- df[1:9, ]
val %>% View

#Training Data Set
train <- df[10:130,]
train %>% View

#Testing Data Set
test <- df[131:nrow(df),]
test %>% View
```

```{r}
#CLASSIFICATION Decision Tree
#install.packages('tree')

#MODEL NUMBER 1 - ALL VARIABLES
model = tree(status_code ~ ., 
             na.action = na.pass, 
             method = "class", 
             split = c("deviance", "gini"),
             data = train)
summary(model)
```

```{r}
#Variables Used in Decision Tree
summary(model)$used
```

```{r}
#Variables Not Used in Decision Tree
names(train)[which(!(names(train) %in% summary(model)$used))]
```

```{r}
#Plotting the Decision Tree
plot(model)
text(model)
```

```{r}
#Confusion Matrix
model_pred = predict(model, train, type = "class")
table(predicted = model_pred, actual = train$status_code)

#MODEL 1 ACCURACY: 97/121 = 80%
```

```{r}
#Pruned Decision Tree
prune = prune.misclass(model, best = 8)
summary(prune)
```

```{r}
plot(prune)
text(prune, pretty = 0)
title(main = "Pruned Classification Tree")
```

```{r}
#Testing the Decision Tree
pred <- predict(model, test) 
pred
```

```{r}
#Feature Selection
control <- trainControl(method="repeatedcv", number=10, repeats=3)
model <- train(status_code~., 
               data=train, 
               method="lvq", 
               preProcess="scale", 
               trControl=control, 
               na.action = na.omit)

importance <- varImp(model, scale=FALSE)
print(importance)
plot(importance)
```
    
```{r}
#Model 2 - First Feature Selection 
model2 = tree(status_code ~ amount_approved + employer + streetzip + 
    incomeamt + incomelevel + purpose + referenceperson, 
             na.action = na.pass, 
             method = "class", 
             split = c("deviance", "gini"),
             data = train)
summary(model2)
save(model2,file = 'model.RData')
```

```{r}
#Plotting the Decision Tree
plot(model2)
text(model2)
```
```{r}
#Pruned Decision Tree
prune2 = prune.misclass(model2, best = 6)
summary(prune2)

plot(prune2)
text(prune2, pretty = 0)
title(main = "Pruned Classification Tree")
```
```{r}
model_pred = predict(model2, train, type = "class")
table(predicted = model_pred, actual = train$status_code)
```

```{r}
#Model 3 - Second Feature Selection
model3 = tree(status_code ~ amount_approved +  employer + age + 
                streetzip + incomeamt + income_source + sex + incomelevel + referenceperson + purpose, 
             na.action = na.pass, 
             method = "class", 
             split = c("deviance", "gini"),
             data = train)
summary(model3)

model_pred = predict(model3, train, type = "class")
table(predicted = model_pred, actual = train$status_code)
```
```{r}
#Model 4 - Charged Off Feature Selection
model4 = tree(status_code ~ amount_approved + 
                streetzip + employer + income_source + referenceperson, 
             na.action = na.pass, 
             method = "class", 
             split = c("deviance", "gini"),
             data = train)
summary(model4)

model_pred = predict(model4, train, type = "class")
table(predicted = model_pred, actual = train$status_code)
```

```{r}
#Model 5 - Paid in Full Feature Selection
model5 = tree(status_code ~ amount_approved +  employer + streetzip,
             na.action = na.pass, 
             method = "class", 
             split = c("deviance", "gini"),
             data = train)
summary(model5)

model_pred = predict(model5, train, type = "class")
table(predicted = model_pred, actual = train$status_code)
```
```{r}
#Model 6 - Paid in Full Feature Selection
model6 = tree(status_code ~ employer + amount_approved + streetzip + incomeamt,
             na.action = na.pass, 
             method = "class", 
             split = c("deviance", "gini"),
             data = train)
summary(model6)

model_pred = predict(model6, train, type = "class")
table(predicted = model_pred, actual = train$status_code)
```




